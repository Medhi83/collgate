{% extends "main/index.html" %}

{% load i18n %}
{% load bootstrap3 %}

{# main_content #}
{% block main_content %}

<style type="text/css">

.left-margin {
    margin-left: 10px;
}

.action {
    cursor: pointer;
}

</style>

<div class="panel panel-default">
    <div class="panel-heading">
        <span style="font-weight:bold; font-size:18px;">
            <span class="btn glyphicon glyphicon-edit" id="cismotif_edit" style="font-size:18px; padding:0px;" data-toggle="tooltip" data-placement="left" title="Edit the taxon"></span>
            <span class="panel-title">{% trans "Detail of a taxon" %}</span>
            <span style="font-size:18px; position:relative; float:right;">
                <span class="btn glyphicon glyphicon-trash" id="cismotif_remove" data-toggle="tooltip" data-placement="left" title="Delete the taxon" style="padding:0px;"></span>
            </span>
        </span>
    </div>
    <div class="panel-body" style="overflow: auto;">
        <div style="width:100%;">
            <span style="font-weight:bold; font-size:18px;">
                <span class="name">{{taxon.name}}</span><span class="level badge left-margin">{{taxon.rank}}</span><br>
            </span>
            <hr>
            <h4>Synonyms</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th><span class="glyphicon glyphicon-asterisk" /></th>
                        <th>{% trans 'Type' %}</th>
                        <th>{% trans 'Name' %}</th>
                        <th>{% trans 'Language' %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for synonym in taxon.synonyms %}
                    <tr>
                        <th scope="row">
                            {% if synonym.type_code != 0 %}<span class="action remove-synonym glyphicon glyphicon-minus-sign"></span>{% endif %}
                        </th>
                        <td name="type" value="{{synonym.type_code}}">{{synonym.type}}</td>
                        <td name="name">{{synonym.name}}</td>
                        <td name="language" value="{{synonym.language_code}}">{{synonym.language}}</td>
                    </tr>
                    {% endfor %}
                    <tr id="dummy_synonym">
                        <th scope="row"><span id="add_synonym" class="action glyphicon glyphicon-plus-sign" style="margin-top: 50%; margin-bottom: 50%;"></span></th>
                        <td>{{dummy_synonym.type}}</td>
                        <td><div class="form-group">{{dummy_synonym.name}}</div></td>
                        <td>{{dummy_synonym.language}}</td>
                     </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">

var taxonId = "{{taxon.id}}";

$(function() {
    // validate the synonym name
    $("[name='name']").bind("input", function(e) {
        var v = e.target.value;
        var re = /^[a-zA-Z0-9_\-]+$/i;

        if (v.length > 0 && !re.test(v)) {
            validateInput($(e.target), 'failed', "{% trans 'Invalid characters (alphanumeric, _ and - only)' %}");
        } else if (v.length < 3) {
            validateInput($(e.target), 'failed', '3 characters min');
        } else {
            $.ajax({
                type: "GET",
                url: '{% url "taxonomy:taxon" %}',
                dataType: 'json',
                data: {term: this.value, type: "name", mode: "ieq"},
                success: function(data) {
                    if (data.length > 0) {
                        for (var i in data) {
                            var t = data[i];

                            if (t.value.toUpperCase() == $(e.target).val().toUpperCase()) {
                                validateInput($(e.target), 'failed', 'Taxon name already in usage');
                                break;
                            }
                        }
                    } else {
                        validateInput($(e.target), 'ok');
                    }
                },
                error: function() {
                    error('Unable to search taxon by name');
                },
            });
        }
    });

    $("#add_synonym").bind("click", function(e) {
        var synonym = $("#dummy_synonym");

        var type = synonym.find("[name='type']").val();
        var name = synonym.find("[name='name']").val();
        var language = synonym.find("[name='language']").val();

        $.ajax({
            type: "PUT",
            url: '{% url "taxonomy:taxon" %}' + taxonId + "/",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: JSON.stringify({type: type, name: name, language: language}),
            success: function(data) {
                if (data.result == "success") {
                    location.reload();
                    /*var table = synonym.parent();

                    var tr = $("<tr></tr");
                    tr.insertBefore(synonym)

                    var th = $('<th scope="row"></th>');
                    tr.append(th);

                    //var td_name = $('<td name="type" value="' + + '">synonym.type</td>')
                    <tr>
                        <th scope="row">
                            if synonym.type_code != 0<span class="action remove-synonym glyphicon glyphicon-minus-sign"></span>endif
                        </th>
                        <td name="type" value="synonym.type_code">synonym.type</td>
                        <td name="name">synonym.name</td>
                        <td name="language" value="synonym.language_code">synonym.language</td>
                    </tr>*/
                } else {

                }
            },
            error: function() {
                error("{% trans 'Unable to add the synonym' %}");
            },
        });
    });

    $(".remove-synonym").bind("click", function(e) {
        var synonym = $(e.target.parentNode.parentNode);

        var type = synonym.find("[name='type']").attr('value');
        var name = synonym.find("[name='name']").text();
        var language = synonym.find("[name='language']").attr('value');

        $.ajax({
            type: "DELETE",
            url: '{% url "taxonomy:taxon" %}' + taxonId + "/",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: JSON.stringify({type: type, name: name, language: language}),
            success: function(data) {
                if (data.result == "success") {
                    e.target.parentNode.parentNode.remove();
                } else {
                    error("{% trans 'Unable to remove the synonym' %}");
                }
            },
            error: function() {
                error("{% trans 'Unable to remove the synonym' %}");
            },
        });
    });
});
</script>

{% endblock %}

{# detail #}

{% block left_content %}
<h3>{% trans "Taxon details" %}</h3>
{% endblock %}

{% block right_content %}
{% include "main/side_bar.html" %}
{% endblock %}
