{% extends "main/index.html" %}

{% load i18n %}
{% load bootstrap3 %}

{# main_content #}
{% block main_content %}

<div class="panel panel-default">
    <div class="panel-heading">
        <h4 class="panel-title">{% trans "Creation of a new taxon" %}</h4>
    </div>
    <div class="panel-body">
        <div style="width:320px">
            <form action="{% url 'taxonomy:taxon-create' %}" method="post" class="form">
                {% csrf_token %}
                {% bootstrap_form form %}
                {% buttons %}
                    <button type="submit" class="btn btn-primary">
                        {% bootstrap_icon "star" %} {% trans "Submit" %}
                    </button>
                {% endbuttons %}
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">

function initValidatable(object) {
    object.oninput = function(e) {
        // TODO add a delay in ms
        var v = e.target.value;
        //var re = e.target.getAttribute('validatable-re') || '/^.*$/i';
        var re = /^[a-zA-Z0-9_\-]+$/i;

        //var minlength = e.target.getAttribute('minlength') || 0;
        //var maxlength = e.target.getAttribute('maxlength') || 4096;

        var sel = $(object);

        if (v.length > 0 && !re.test(v)) {
            validateInput(sel, 'failed', "{% trans 'Invalid characters (alphanumeric, _ and - only)' %}");
        } else if (v.length < 3) {
            validateInput(sel, 'failed', '3 characters min');
        } else {
            $.ajax({
                type: "GET",
                url: '{% url "taxonomy:taxon" %}',
                dataType: 'json',
                data: {term: this.value, type: "name", mode: "ieq"},
                success: function(data) {
                    if (data.length > 0) {
                        for (var i in data) {
                            var t = data[i];

                            if (t.value.toUpperCase() == sel.val().toUpperCase()) {
                                validateInput(sel, 'failed', 'Taxon name already in usage');
                                break;
                            }
                        }
                    } else {
                        validateInput(sel, 'ok');
                    }
                },
                error: function() {
                    error('Unable to search taxon by name');
                },
            });
        }
    }
}

$(function() {
    // initiate any validatable
    // $(".validatable").each(function(i) {
    //     initValidatable(this);
    // });

    initValidatable(document.getElementById("id_name"));
/*
    // validate the taxon name
    document.getElementById("id_name").oninput = function(e) {
        // TODO add a delay and make this more generic and reusable
        var v = e.target.value;
        var re = /^[a-zA-Z0-9_\-]+$/i;

        if (v.length > 0 && !re.test(v)) {
            validateInput($("#id_name"), 'failed', "{% trans 'Invalid characters (alphanumeric, _ and - only)' %}");
        } else if (v.length < 3) {
            validateInput($("#id_name"), 'failed', '3 characters min');
        } else {
            $.ajax({
                type: "GET",
                url: '{% url "taxonomy:taxon" %}',
                dataType: 'json',
                data: {term: this.value, type: "name", mode: "ieq"},
                success: function(data) {
                    if (data.length > 0) {
                        for (var i in data) {
                            var t = data[i];

                            if (t.value.toUpperCase() == $("#id_name").val().toUpperCase()) {
                                validateInput($('#id_name'), 'failed', 'Taxon name already in usage');
                                break;
                            }
                        }
                    } else {
                        validateInput($("#id_name"), 'ok');
                    }
                },
                error: function() {
                    error('Unable to search taxon by name');
                },
            });
        }
    };*/
});
</script>

{% endblock %}

{# detail #}

{% block left_content %}
<h3>{% trans "Create taxonomy" %}</h3>
{% endblock %}

{% block right_content %}
{% include "main/side_bar.html" %}
{% endblock %}
